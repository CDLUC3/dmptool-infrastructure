AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS Batch used to process datasets for DMP Tool Related Works Matching'

Parameters:
  VpcId:
    Type: 'AWS::EC2::VPC::Id'

  SubnetId:
    Type: 'AWS::EC2::Subnet::Id'

  SecurityGroupID:
    Type: 'String'

  EcrRepositoryName:
    Type: 'String'

  S3RelatedWorksBucketID:
    Type: 'String'

  OpenSearchCollectionArn:
    Type: 'String'

  EcrImageName:
    Type: 'String'
    Default: 'dmpworks-x86'

Resources:
  BatchComputeEnvironment:
    Type: 'AWS::Batch::ComputeEnvironment'
    DependsOn:
      - BatchServiceRole
      - BatchLaunchTemplate
      - BatchInstanceProfile
    Properties:
      # ComputeEnvironmentName: don't give it a name, because if it needs to be
      # updated, it deletes and recreates the compute environment, however, it
      # can't do this with a static name.
      Type: 'MANAGED'
      ServiceRole: !Ref BatchServiceRole
      ComputeResources:
        Type: 'EC2'
        Ec2Configuration:
          - ImageType: 'ECS_AL2023'
        AllocationStrategy: 'BEST_FIT' # https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-properties-batch-computeenvironment-computeresources.html#cfn-batch-computeenvironment-computeresources-allocationstrategy
        MinvCpus: 0
        MaxvCpus: 128
        DesiredvCpus: 0
        InstanceTypes:
          - 'c5ad.large' # 2 vCPUs, 4 GiB memory. ROR and OpenAlex funders. Small cheap instance with NVMe. AMD EPYC 7R32. Up to Gigabit.
          - 'c5ad.8xlarge' # 32 vCPUs, 64 GiB memory. OpenAlex Works, DataCite, Crossref Metadata.
          - 'r5dn.8xlarge' # 32 vCPUs, 256 GiB memory. SQL Mesh. Intel Xeon Platinum 8259 (Cascade Lake). 25 Gigabit.
          - 'm5dn.2xlarge' # 8 vCPUs, 32 GiB memory. OpenSearch ingest.
        LaunchTemplate:
          LaunchTemplateId: !Ref BatchLaunchTemplate
          Version: !GetAtt BatchLaunchTemplate.LatestVersionNumber
        Subnets:
          - !Ref SubnetId
        SecurityGroupIds:
          - !Ref SecurityGroupID
        InstanceRole: !Ref BatchInstanceProfile

  BatchLaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Properties:
      LaunchTemplateName: !Sub '${AWS::StackName}-launch-template'
      LaunchTemplateData:
        BlockDeviceMappings:
          - DeviceName: '/dev/xvda' # Amazon Linux root volume
            Ebs:
              VolumeType: 'gp3'
              DeleteOnTermination: true
              VolumeSize: 30 # GB
        UserData:
          Fn::Base64: !Sub |
            MIME-Version: 1.0
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            
            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset="us-ascii"
            
            #!/bin/bash
            set -uxo pipefail
            
            # Save Cloud Watch Agent config
            cat > /tmp/amazon-cloudwatch-agent.json << 'CWA_SCRIPT'
            {
              "agent": {
                "run_as_user": "root"
              },
              "metrics": {
                "metrics_collected": {
                  "mem": {
                    "measurement": [
                      "mem_used_percent",
                      "mem_total",
                      "mem_used"
                    ],
                    "metrics_collection_interval": 60
                  },
                  "disk": {
                    "resources": [
                      "/",
                      "/data"
                    ],
                    "measurement": [
                      "used_percent",
                      "total"
                    ],
                    "drop_device_metrics": true,
                    "metrics_collection_interval": 60
                  }
                },
                "append_dimensions": {
                  "InstanceId": "${!aws:InstanceId}"
                }
              }
            }
            CWA_SCRIPT

            cat > /tmp/setup-instance.sh << 'SCRIPT'
            #!/bin/bash
            set -uxo pipefail

            # Refresh local list of available packages
            dnf update -y
          
            # Install any required system dependencies
            dnf install amazon-cloudwatch-agent mdadm -y

            # Mount disks to /data dir
            if lsblk | grep -q nvme1n1 && lsblk | grep -q nvme2n1; then
              # Mount two disks to /data dir
          
              # Create RAID 0 (if not already exists)
              if [ ! -e /dev/md0 ]; then
                mdadm --create --verbose /dev/md0 --level=0 --raid-devices=2 /dev/nvme1n1 /dev/nvme2n1 --assume-clean --run
              fi
          
              # Persist RAID config
              mkdir -p /etc/mdadm
              mdadm --detail --scan >> /etc/mdadm/mdadm.conf
          
              # Format if not already formatted
              if ! blkid /dev/md0; then
                mkfs.ext4 -F /dev/md0
              fi
          
              # Mount to /data
              mkdir -p /data
              echo "/dev/md0 /data ext4 defaults,nofail 0 2" >> /etc/fstab
              mount /data            
            elif lsblk | grep -q nvme1n1; then
              # Mount single disk to /data dir
              mkfs.ext4 /dev/nvme1n1
              mkdir -p /data
              echo "/dev/nvme1n1 /data ext4 defaults,nofail 0 2" >> /etc/fstab
              mount /data
            fi
            
            # Start Cloud Watch Agent with config
            cp /tmp/amazon-cloudwatch-agent.json /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
            
            SCRIPT

            # Run the script only once on the instance
            cloud-init-per instance setup-instance /bin/bash /tmp/setup-instance.sh
            
            --==BOUNDARY==--

  BatchServiceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub '${AWS::StackName}-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'batch.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole'

  BatchInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    DependsOn:
      - BatchInstanceRole
    Properties:
      InstanceProfileName: !Sub '${AWS::StackName}-instance-profile'
      Roles:
        - !Ref BatchInstanceRole

  BatchInstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub '${AWS::StackName}-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'ec2.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'

  BatchJobQueue:
    Type: 'AWS::Batch::JobQueue'
    DependsOn:
      - BatchComputeEnvironment
    Properties:
      JobQueueName: !Sub '${AWS::StackName}-job-queue'
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironment
      State: 'ENABLED'
      Priority: 1

  BatchJobRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub '${AWS::StackName}-job-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'ecs-tasks.amazonaws.com'
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: 'RelatedWorksAossPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'aoss:APIAccessAll'
                Resource:
                  - !Ref OpenSearchCollectionArn
        - PolicyName: 'RelatedWorksS3Policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 's3:PutObject'
                - 's3:GetObject'
                - 's3:DeleteObject'
                - 's3:ListBucket'
              Resource:
                - !Sub 'arn:aws:s3:::${S3RelatedWorksBucketID}'
                - !Sub 'arn:aws:s3:::${S3RelatedWorksBucketID}/*'
        - PolicyName: 'CrossrefMetadataS3Policy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 's3:GetObject'
                - 's3:ListBucket'
              Resource:
                - 'arn:aws:s3:::api-snapshots-reqpays-crossref'
                - 'arn:aws:s3:::api-snapshots-reqpays-crossref/*'
        - PolicyName: 'DataCiteStaticIpPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: 'Allow'
              Action:
                - 'ec2:DescribeInstances'
                - 'ec2:AssociateAddress'
              Resource:
                - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
              Condition:
                StringLike:
                  aws:userid: "*:${ec2:InstanceID}"

      ManagedPolicyArns:
        # Allow EC2 instance to access ECR
        - 'arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'

  DMPWorksJob:
    Type: 'AWS::Batch::JobDefinition'
    DependsOn:
      - BatchJobRole
    Properties:
      Type: 'Container'
      JobDefinitionName: !Sub '${AWS::StackName}-dmpworks-job'
      PlatformCapabilities:
        - 'EC2'
      ContainerProperties:
        Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EcrRepositoryName}:${EcrImageName}'
        Vcpus: 1
        Memory: 1024
        Volumes:
          - Host:
              SourcePath: '/data'
            Name: 'data-volume'
        MountPoints:
          - SourceVolume: 'data-volume'
            ContainerPath: '/data'
            ReadOnly: false
        JobRoleArn: !Ref BatchJobRole
        Command:
          - '/bin/bash'
          - '-c'
          - 'dmpworks --version'

Outputs:
  BatchJobRoleArn:
    Value: !GetAtt BatchJobRole.Arn
