[SERVICE]
    Parsers_file /fluent-bit/etc/parsers.conf

# Step 1: Rename original log
[FILTER]
    Name Modify
    Match *
    Rename log log_orig

# Step 2: Parse Docker JSON
[FILTER]
    Name Parser
    Match *
    Parser docker
    Key_Name log_orig
    Reserve_Data On
    Preserve_Key On

# Step 3: Copy/keep the important fields at the top level
[FILTER]
    Name Modify
    Match *
    Copy log_orig.@timestamp @timestamp
    Copy log_orig.env env
    Copy log_orig.requestId requestId
    Copy log_orig.jti jti
    Copy log_orig.userId userId
    Copy log_orig.message message
    Copy log_orig.log.level log_level
    Copy log_orig.docker.container_id docker.container_id
    Copy log_orig.docker.container_name docker.container_name
    Copy log_orig.docker.log_orig docker.log_orig

# Step 4: Nest everything else into `extra` so we don't exceed the 1,000 field limit
[FILTER]
    Name Nest
    Match *
    Operation nest
    Wildcard *
    Nest_under extra
    Remove_prefix true
