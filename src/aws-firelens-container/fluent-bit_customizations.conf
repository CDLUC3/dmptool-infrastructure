[SERVICE]
    Parsers_file /fluent-bit/etc/parsers.conf

# Step 1: Rename the original Docker log
[FILTER]
    Name Modify
    Match *
    Rename log log_orig

# Step 2: Parse the Docker JSON envelope
[FILTER]
    Name Parser
    Match *
    Parser docker
    Key_Name log_orig
    Reserve_Data On
    Preserve_Key On

# Step 3: Try parsing the application log (inside docker.log or docker.log_orig) as JSON
[FILTER]
    Name Parser
    Match *
    Parser json
    Key_Name log
    Reserve_Data On
    Preserve_Key On

# Step 4: Nest everything under `extra`
[FILTER]
    Name Nest
    Match *
    Operation nest
    Wildcard *
    Nest_under extra
    Remove_prefix false

# Step 4: Promote important fields if they exist
[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.@timestamp
    Copy extra.@timestamp @timestamp

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.env
    Copy extra.env env

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.requestId
    Copy extra.requestId requestId

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.jti
    Copy extra.jti jti

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.userId
    Copy extra.userId userId

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.message
    Copy extra.message message

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.log.level
    Copy extra.log.level log_level

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.docker.container_id
    Copy extra.docker.container_id docker_container_id

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.docker.container_name
    Copy extra.docker.container_name docker_container_name

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.docker.log_orig
    Copy extra.docker.log_orig docker_log_orig
