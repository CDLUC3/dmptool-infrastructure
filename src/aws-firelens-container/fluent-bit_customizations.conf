[SERVICE]
    Parsers_file /fluent-bit/etc/parsers.conf

# Step 1: Rename the original Docker log
[FILTER]
    Name Modify
    Match *
    Rename log log_orig

# Step 2: Parse the Docker JSON envelope
[FILTER]
    Name Parser
    Match *
    Parser docker
    Key_Name log_orig
    Reserve_Data On
    Preserve_Key On

# Step 3: Try parsing the application log (inside docker.log or docker.log_orig) as JSON
[FILTER]
    Name Parser
    Match *
    Parser json
    Key_Name log
    Reserve_Data On
    Preserve_Key On

# Step 4: Promote important fields if they exist
[FILTER]
    Name Modify
    Match *
    Condition Key_exists @timestamp
    Copy @timestamp @timestamp

[FILTER]
    Name Modify
    Match *
    Condition Key_exists env
    Copy env env

[FILTER]
    Name Modify
    Match *
    Condition Key_exists requestId
    Copy requestId requestId

[FILTER]
    Name Modify
    Match *
    Condition Key_exists jti
    Copy jti jti

[FILTER]
    Name Modify
    Match *
    Condition Key_exists userId
    Copy userId userId

[FILTER]
    Name Modify
    Match *
    Condition Key_exists message
    Copy message message

[FILTER]
    Name Modify
    Match *
    Condition Key_exists log_level
    Copy log.level log_level

[FILTER]
    Name Modify
    Match *
    Condition Key_exists container_id
    Copy extra.docker.container_id container_id

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.docker.container_name
    Copy extra.docker.container_name docker_container_name

[FILTER]
    Name Modify
    Match *
    Condition Key_exists extra.docker.log_orig
    Copy extra.docker.log_orig docker_log_orig

# Step 5: Nest everything under `extra`
[FILTER]
    Name Nest
    Match *
    Operation nest
    Wildcard *
    Nest_under extra
    Remove_prefix false
